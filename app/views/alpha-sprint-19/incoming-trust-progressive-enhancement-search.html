{% extends "layouts/main.html" %}

{% set pageName="Search for outgoing trust" %}

{% block beforeContent %}
  {{ govukBackLink({
    text: "Back",
    href: "javascript:window.history.back()"
  }) }}
{% endblock %}

{% block content %}
<!-- Include accessible autocomplete library -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/accessible-autocomplete@2.0.4/dist/accessible-autocomplete.min.css">
<script src="https://cdn.jsdelivr.net/npm/accessible-autocomplete@2.0.4/dist/accessible-autocomplete.min.js"></script>

<style>
  /* Fix alignment and styling issues */
  .autocomplete__wrapper {
    width: 100%;
  }
  
  .autocomplete__input {
    width: 100%;
    box-sizing: border-box;
  }
  
  .autocomplete__dropdown-arrow-down {
    right: 8px;
  }
  
  /* Ensure dropdown aligns with input */
  .autocomplete__menu {
    width: 100% !important;
    left: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  
  .autocomplete__option {
    padding: 8px 12px;
    border-bottom: 1px solid #b1b4b6;
  }
  
  .autocomplete__option:last-child {
    border-bottom: none;
  }
  
  /* Hide "No results found" when there are results */
  .autocomplete__option--no-results {
    display: none !important;
  }
</style>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">

    <form class="form" action="incoming-trust-progressive-enhancement-confirmation" method="get">
      <div class="govuk-form-group">
        <h1 class="govuk-label-wrapper">
          <label class="govuk-label govuk-label--xl" for="create-new-project-academy-name">
            <span class="govuk-caption-l">Trust details</span>
            Search for the trust by name or reference number
          </label>
        </h1>

        <div class="govuk-hint">
          Enter at least 3 characters for name or UK provider reference number (UKPRN)
        </div>
        
        <!-- Hidden input to track edit mode -->
        {% if data.editIndex !== undefined %}
        <input type="hidden" name="edit" value="{{ data.editIndex }}">
        {% endif %}
        
        <!-- Hidden select element that will be enhanced -->
        <select id="incoming-trust-progressive-enhancement-search" name="incoming-trust-progressive-enhancement-search" style="display: none;">
          <option value=""></option>
          {% for trust in trusts %}
          <option value="{{ trust.name }}" data-ukprn="{{ trust.ukprn }}" data-company-house="{{ trust.companyHouseNumber }}">
            {{ trust.name }} - UKPRN: {{ trust.ukprn }} - Companies House: {{ trust.companyHouseNumber }}
          </option>
          {% endfor %}
        </select>
        
      </div>

      {{ govukButton({
        text: "Search"
      }) }}
    </form>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const autocomplete = accessibleAutocomplete.enhanceSelectElement({
          selectElement: document.querySelector('#incoming-trust-progressive-enhancement-search'),
          showAllValues: true,
          minLength: 0,
          autoselect: false,
          confirmOnBlur: false
        });

        // Handle form submission to ensure the selected value is properly set
        document.querySelector('form').addEventListener('submit', function(e) {
          const selectedValue = document.querySelector('#incoming-trust-progressive-enhancement-search').value;
          if (!selectedValue) {
            e.preventDefault();
            alert('Please select a trust before continuing.');
            return false;
          }
        });
      });
    </script>

  </div>
</div>
{% endblock %} 